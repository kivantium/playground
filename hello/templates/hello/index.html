<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>にじさーち</title>
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <style> .media-content{ white-space: nowrap; overflow: hidden} </style>
  </head>
  <body>
  <nav class="navbar is-primary">
    <div class="navbar-brand navbar-item">
      <h1 class="title has-text-light">にじさーち</h1>
    </div>
    {% if request.user.is_authenticated %}
    <div class="navbar-end">
      <div class="navbar-item">
      <a class="button is-light" href="/logout">ログアウト</a>
      </div>
    {% endif %}
    </div>
  </nav>
  <section class="section">
    <p>タイムラインからイラストのみを選んで表示します</p>
    {% if request.user.is_authenticated %}
    <div id="app">
      <div class="container">
        <div class="columns is-mobile is-multiline">
          <div v-for="status in status_list" class="column is-4-desktop is-4-tablet is-6-mobile">
            <div class="card">
              <div class="card-content">
                <div class="media">
                  <div class="media-left">
                    <figure class="image is-48x48">
                      <img v-bind:src="[[ status.profile_image_url ]]" alt="Profile image">
                    </figure>
                  </div>
                  <div class="media-content">
                    <p class="title is-6">[[ status.author.name ]]</p>
                    <p class="subtitle is-6">@[[ status.author.screen_name ]]</p>
                  </div>
                </div>
                <div class="card-image">
                  <figure class="image">
                    <a v-bind:href="[['https://twitter.com/i/web/status/' + status.id_str ]]" target="_blank" rel="noopener noreferrer">
                      <img v-bind:src="[[ status.image_url ]]" alt="main image">
                    </a>
                  </figure>
                </div>
                <div class="content">[[ status.text ]]</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-if="limit_reached" class="notification is-warning is-light">取得できるツイート数の上限に達しました。</div>
      <div v-if="closed" class="notification is-warning is-light">サーバーとの接続が切断されました</div>
    </div>
    {% else %}
    <p>利用するにはログインが必要です</p>
    <button class="button is-info" onclick="location.href='{% url 'social:begin' 'twitter' %}'">
      <span class="icon"><i class="fab fa-twitter"></i></span><span>Twitterでログイン</span>
    </button>
    {% endif %}
  </section>
  {% if request.user.is_authenticated %}
  <script>
    var vm = new Vue({
      delimiters: ['[[', ']]'],
      el: '#app',
      data: {
          status_list: [],
          limit_reached: false,
          closed: false,
      },
      mounted: function() {
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(
          ws_scheme + '://' + window.location.host + '/ws/chat/test/'
        );
        chatSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          if(data.limit_reached) {
            console.error('Reached rate limit');
            vm.limit_reached = true;
          } else {
            vm.status_list.push(data.content);
          }
        };

        chatSocket.onclose = function(e) {
          console.error('Chat socket closed unexpectedly');
          vm.closed = true;
        };
      }
    })
  </script>
  {% endif %}
  </body>
</html>
